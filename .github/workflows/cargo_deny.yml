name: Cargo Deny (Reusable)

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

env:
  CARGO_TERM_VERBOSE: true

jobs:
  cargo-deny:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@fcf085fcb4b4b8f63f96906cd713eb52181b5ea4
        with:
          toolchain: stable

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6
        with:
          shared-key: "cargo-deny"

      - name: Install cargo-deny
        run: |
          cargo install --locked cargo-deny --git https://github.com/npetzall/cargo-deny --branch sarif_test

      - name: Run cargo deny check
        run: |
          cargo deny --format sarif check advisories > cargo-deny.sarif

      - name: Upload SARIF report
        if: |
          (github.ref == format('refs/heads/{0}', github.event.repository.default_branch)) ||
          (github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          RESPONSE=$(gh api repos/${{ github.repository }}/code-scanning/sarifs \
            --method POST \
            -f commit_sha="${{ github.sha }}" \
            -f ref="${{ github.ref }}" \
            -f tool_name="cargo-deny" \
            -f checkout_uri="file://${{ github.workspace }}" \
            -f sarif=$(gzip -c cargo-deny.sarif | base64 -w 0))
          
          echo "Upload response: $RESPONSE"
          
          SARIF_ID=$(echo "$RESPONSE" | jq -r '.id')
          SARIF_URL=$(echo "$RESPONSE" | jq -r '.url')
          
          echo "SARIF ID: $SARIF_ID"
          echo "SARIF URL: $SARIF_URL"
          
          # Extract API path from URL (remove https://api.github.com/ prefix)
          SARIF_API_PATH=$(echo "$SARIF_URL" | sed 's|https://api.github.com/||')
          echo "SARIF API Path: $SARIF_API_PATH"
          
          # Make 5 calls to check the status
          for i in {1..5}; do
            echo "=== Call $i ==="
            CALL_RESPONSE=$(gh api "$SARIF_API_PATH")
            echo "$CALL_RESPONSE"
            sleep 2
          done

      - name: Generate job summary
        if: always()
        run: |
          .github/scripts/cargo-deny2md.sh cargo-deny.sarif

