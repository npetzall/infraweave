name: Build Python Wheels Maturin (Reusable)

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
        description: Version of the Python package to build (e.g., 0.1.0)
  workflow_dispatch:
    inputs:
      version:
        required: false
        type: string
        description: Version of the Python package to build (e.g., 0.1.0)
        default: 0.0.0-manual

env:
  VERSION: ${{ inputs.version }}

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Validate targets
        run: |
          missing=$(jq -r --argjson targets '${{ vars.TARGETS }}' '
            .[] | select(. as $t | $targets | has($t) | not)
          ' <<< '${{ vars.PYTHON_WHEELS }}' | sort -u)
          
          if [ -n "$missing" ]; then
            missing_list=$(echo "$missing" | tr '\n' ',' | sed 's/,$//')
            echo "::error::Missing TARGETS: $missing_list"
            exit 1
          fi
        shell: bash
      
      - name: Setup build matrix
        id: set-matrix
        run: |
          matrix=$(echo 'null' | jq -c '
            {
              include: ([$python_wheels[] | . as $target_name | $targets[$target_name] | {
                name: $target_name,
                rust_target: .rust_target,
                runner: .runner,
                cross: (if (. | has("cross")) then .cross else true end)
              }])
            }
          ' --argjson targets '${{ vars.TARGETS }}' --argjson python_wheels '${{ vars.PYTHON_WHEELS }}')
          
          echo "matrix=$matrix" >> $GITHUB_OUTPUT
        shell: bash

  build:
    name: Build wheel (${{ matrix.name }})
    needs: setup
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@fcf085fcb4b4b8f63f96906cd713eb52181b5ea4
        with:
          toolchain: stable
          targets: ${{ matrix.rust_target }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: 3.x

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6
        with:
          shared-key: "deps-${{ matrix.rust_target }}"
          save-if: ${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}

      - name: Install cross
        if: ${{ matrix.cross == true }}
        run: cargo install cross --git https://github.com/cross-rs/cross --rev 49cd054de9b832dfc11a4895c72b0aef533b5c6a

      - name: Install maturin
        run: pip install maturin

      - name: Build with cross
        if: ${{ matrix.cross == true }}
        env:
          CARGO: cross
          CARGO_TERM_VERBOSE: true
        run: maturin build --release --target ${{ matrix.rust_target }} --manifest-path ./infraweave_py/Cargo.toml --out dist

      - name: Build with cargo
        if: ${{ matrix.cross == false }}
        env:
          CARGO_TERM_VERBOSE: true
        run: maturin build --release --target ${{ matrix.rust_target }} --manifest-path infraweave_py/Cargo.toml --out dist

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.name }}
          path: dist/*
          retention-days: 7
