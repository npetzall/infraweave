name: Test (Reusable)

on:
  workflow_call:
  workflow_dispatch:

permissions:
  contents: read

jobs:
  build-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        uses: ./.github/actions/free-disk-space
        with:
          level: "maximum"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@fcf085fcb4b4b8f63f96906cd713eb52181b5ea4
        with:
          toolchain: stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
        with:
          shared-key: "test"
          save-if: ${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}

      - name: Build Tests
        run: cargo build --tests --workspace --exclude infraweave_py

  unit-tests:
    needs: build-tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        uses: ./.github/actions/free-disk-space
        with:
          level: "maximum"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@fcf085fcb4b4b8f63f96906cd713eb52181b5ea4
        with:
          toolchain: stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
        with:
          shared-key: "test"
          save-if: ${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}

      - name: Run Tests
        run: cargo test --workspace --exclude infraweave_py --exclude integration-tests

  integration-tests-matrix:
    runs-on: ubuntu-latest
    outputs:
      tests: ${{ steps.set-matrix.outputs.tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        uses: ./.github/actions/free-disk-space
        with:
          level: "maximum"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@fcf085fcb4b4b8f63f96906cd713eb52181b5ea4
        with:
          toolchain: stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
        with:
          shared-key: "test"
          save-if: ${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}

      - name: Create integration tests list
        id: set-matrix
        run: |
          cd integration-tests/tests
          tests=$(ls -1 *.rs 2>/dev/null | sed 's/\.rs$//' | awk 'BEGIN{printf "["} {if(NR>1)printf ","; printf "\"%s\"", $0} END{printf "]"}')
          echo "tests=$tests" >> $GITHUB_OUTPUT

  integration-test:
    name: Integration Test (${{provider.provider}} - ${{ matrix.test }})
    needs: [build-tests, integration-tests-matrix]
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        provider:
          - PROVIDER: aws
            INFRAWEAVE_ENV: dev
            INFRAWEAVE_API_FUNCTION: function
            AWS_ACCESS_KEY_ID: dummy
            AWS_SECRET_ACCESS_KEY: dummy
            AWS_REGION: us-east-1
            TEST_MODE: true
            CONCURRENCY_LIMIT: 1
          - PROVIDER: azure
            INFRAWEAVE_ENV: dev
            INFRAWEAVE_API_FUNCTION: function
            AZURE_CLIENT_ID: dummy
            AZURE_CLIENT_SECRET: dummy
            AZURE_TENANT_ID: dummy
            REGION: westus2
            TEST_MODE: true
            CONCURRENCY_LIMIT: 1
        test: ${{ fromJson(needs.integration-tests-matrix.outputs.tests) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Free up disk space
        uses: ./.github/actions/free-disk-space
        with:
          level: "maximum"

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@fcf085fcb4b4b8f63f96906cd713eb52181b5ea4
        with:
          toolchain: stable

      - name: Rust Cache
        uses: Swatinem/rust-cache@f13886b937689c021905a6b90929199931d60db1 # v2.8.1
        with:
          shared-key: "test"
          save-if: ${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}

      - name: Run Tests
        run: cargo test -p integration-tests --test ${{ matrix.test }} -- --test-threads=1
        env: ${{ matrix.provider }}