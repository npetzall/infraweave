name: Build CLI (Reusable)

on:
  workflow_call:
    inputs:
      version:
        required: true
        type: string
        description: Version of the CLI to build (e.g., 0.1.0)
  workflow_dispatch:
    inputs:
      version:
        required: false
        type: string
        description: Version of the CLI to build (e.g., 0.1.0)
        default: 0.0.0-manual
env:
  VERSION: ${{ inputs.version }}

jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - name: Validate targets
        run: |
          missing=$(jq -r --argjson targets "${{ vars.BINARY_TARGETS }}" '
            .[] | .targets[] | select(. as $t | $targets | has($t) | not)
          ' <<< "${{ vars.BINARIES }}" | sort -u)
          
          if [ -n "$missing" ]; then
            echo "Error: The following targets in binaries are not found in targets:" >&2
            echo "$missing" | sed 's/^/  - /' >&2
            exit 1
          fi
        shell: bash

      - name: Setup build matrix
        id: set-matrix
        run: |
          matrix=$(jq -c '
            $targets | to_entries | map({
              name: .key,
              rust_target: .value.rust_target,
              runner: .value.runner,
              bins: [$binaries[] | select(.targets | index(.key)) | .bin]
            })
          ' --argjson targets "${{ vars.BINARY_TARGETS }}" --argjson binaries "${{ vars.BINARIES }}")
          
          echo "matrix<<EOF" >> $GITHUB_OUTPUT
          echo "$matrix" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        shell: bash

      
  build:
    name: Build (${{ matrix.name }})
    needs: setup
    strategy:
      matrix: ${{ fromJson(needs.setup.outputs.matrix) }}
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@fcf085fcb4b4b8f63f96906cd713eb52181b5ea4
        with:
          toolchain: stable
          targets: ${{ matrix.rust_target }}
        
      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@9d47c6ad4b02e050fd481d890b2ea34778fd09d6
        with:
          shared-key: "deps-${{ matrix.rust_target }}"
          save-if: ${{ github.ref == format('refs/heads/{0}', github.event.repository.default_branch) }}

      - name: Install cross
        run: cargo install cross --locked

      - name: Build
        run: cross build --release --verbose --locked --target ${{ matrix.rust_target }} --bin ${{ join(matrix.bins, ' --bin ') }}

      - name: Prepare artifact (Windows)
        if: runner.os == 'Windows'
        shell: bash
        run: |
          mkdir -p release
          for bin in ${{ join(matrix.bins, ' ') }}; do
            cp "target/${{ matrix.rust_target }}/release/$bin.exe" "release/$bin-${{ matrix.name }}.exe"
          done
          
      - name: Prepare artifact (Unix)
        if: runner.os != 'Windows'
        shell: bash
        run: |
          mkdir -p release
          for bin in ${{ join(matrix.bins, ' ') }}; do
            cp "target/${{ matrix.rust_target }}/release/$bin" "release/$bin-${{ matrix.name }}"
          done

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: binaries-${{ matrix.name }}
          path: release/*
          retention-days: 7

